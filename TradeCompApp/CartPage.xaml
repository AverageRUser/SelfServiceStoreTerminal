<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="TradeCompApp.CartPage"
              xmlns:viewmodels="clr-namespace:TradeCompApp.ViewModels"
              xmlns:behavior="clr-namespace:TradeCompApp.Models.Behaviors"
             Title="Корзина"
             BackgroundColor="{StaticResource PageBackground}">
    <Grid RowDefinitions="Auto,*,Auto" RowSpacing="5">
        <!-- Шапка -->
        <Frame Grid.Row="0" 
               CornerRadius="16"
               BackgroundColor="White"
               Padding="15,10"
               HasShadow="True">
            <Label Text="Ваши товары" 
                   FontSize="24"
                   TextColor="{StaticResource PrimaryText}"
                   FontAttributes="Bold"
                   HorizontalOptions="Center"/>
        </Frame>

        <CollectionView x:Name="CartItemsList" 
                          ItemsSource="{Binding CartProduction}"
                          SelectionMode="None" Grid.Row="1">
            <CollectionView.ItemsLayout>
                <LinearItemsLayout Orientation="Vertical" ItemSpacing="5"/>
            </CollectionView.ItemsLayout>
            <CollectionView.ItemTemplate>
                    
                    <DataTemplate>
                        <Frame Padding="0" 
                               Margin="0,0,0,15"
                               CornerRadius="16"
                               BackgroundColor="White"
                               HasShadow="True" >

                            <Grid Padding="15" RowSpacing="10" ColumnSpacing="15">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="120"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

      
                                <Image Source="{Binding Product.ImageUrl}"   Aspect="AspectFill"   Grid.RowSpan="3"/>

 
                                <VerticalStackLayout Grid.Column="1" Grid.Row="0">
                                    <Label Text="{Binding Product.Name}" 
                                           FontSize="18"
                                           TextColor="{StaticResource PrimaryText}"
                                           FontAttributes="Bold"/>

                                    <Label Text="{Binding Product.Price, StringFormat='{0:C}'}" 
                                           FontSize="16"
                                           TextColor="{StaticResource PrimaryButton}"/>
                                </VerticalStackLayout>

                                <!-- Stepper -->
                                <Frame Grid.Column="1" Grid.Row="1"
                                       CornerRadius="12"
                                       BorderColor="#E0E0E0"
                                       BackgroundColor="White"
                                       Padding="0"
                                       HorizontalOptions="Start">
                                    <HorizontalStackLayout Spacing="0">
                                        <Button Text="-" 
                                               Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:CartViewModel}}, Path=DistQuantityCommand}"
                                               CommandParameter="{Binding .}"
                                               BackgroundColor="Transparent" 
                                               TextColor="Black" 
                                               FontSize="Medium" 
                                               WidthRequest="45"
                                               HeightRequest="45"
                                               IsEnabled="{Binding ButtonIsEnabled}"/>

                                        <BoxView WidthRequest="1" Color="#E0E0E0"/>
                                        <Label Text="{Binding Quantity}" 
                                               FontSize="18"
                                               VerticalOptions="Center" 
                                               HorizontalOptions="Center" 
                                               WidthRequest="45"/>
                                        <BoxView WidthRequest="1" Color="#E0E0E0"/>

                                        <Button Text="+" 
                                               Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:CartViewModel}}, Path=AddQuantityCommand}" 
                                               CommandParameter="{Binding .}"  
                                               BackgroundColor="Transparent"  
                                               TextColor="Black" 
                                               FontSize="Medium" 
                                               WidthRequest="45"
                                               HeightRequest="45"/>
                                    </HorizontalStackLayout>
                                </Frame>

                                <FlexLayout Grid.Column="1" Grid.Row="2"
                                            BindableLayout.ItemsSource="{Binding Services}"
                                            Wrap="Wrap"
                                            Direction="Row"
                                            AlignItems="Start" >
                                    <BindableLayout.ItemTemplate>
                                        <DataTemplate>
                                            <Frame Padding="10,5"
                                                   CornerRadius="8"
                                                   BackgroundColor="#F8F8F8" Margin="0,0,10,10">
                                                <HorizontalStackLayout Spacing="8">
                                                    <CheckBox IsChecked="{Binding IsSelectedService, Mode=TwoWay}" 
                                                             Color="{StaticResource PrimaryButton}"/>
                                                    <Label Text="{Binding Name}" 
                                                           FontSize="14"
                                                           VerticalOptions="Center"/>
                                                    <Label Text="{Binding Price, StringFormat='{0:C}'}" 
                                                           FontSize="14"
                                                           TextColor="Green" 
                                                           VerticalOptions="Center"/>
                                                </HorizontalStackLayout>
                                            </Frame>
                                        </DataTemplate>
                                    </BindableLayout.ItemTemplate>
                                </FlexLayout>

                                <Button Grid.Column="1" Grid.Row="1"
                                        Text="✕"
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:CartViewModel}}, Path=RemoveCommand}"
                                        CommandParameter="{Binding .}"
                                        BackgroundColor="#FFEBEE"
                                        TextColor="#D32F2F"
                                        FontSize="16"
                                        WidthRequest="45"
                                        HeightRequest="45"
                                        CornerRadius="22"
                                        HorizontalOptions="End"/>
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>


        <!-- Нижняя панель -->
        <Frame Grid.Row="2"
               CornerRadius="16"
               BackgroundColor="White"
               Padding="15,10"
               HasShadow="True">
            <Grid ColumnDefinitions="*,*,*,2*" ColumnSpacing="10">
                <Button Text="Назад"
                        Clicked="OnContinueShoppingClicked"
                        BackgroundColor="{StaticResource SecondaryButton}"
                        TextColor="White"
                        CornerRadius="10"
                        HeightRequest="50"
                        Grid.Column="0"/>

                <Button Text="Каталог"
                        Clicked="OnAddManualProductClicked"
                        BackgroundColor="{StaticResource SecondaryButton}"
                        TextColor="White"
                        CornerRadius="10"
                        HeightRequest="50"
                        Grid.Column="1"/>

                <Button Text="Оплатить"
                        Clicked="OnProceedToPaymentClicked"
                        BackgroundColor="{StaticResource PrimaryButton}"
                        TextColor="White"
                        FontAttributes="Bold"
                        CornerRadius="10"
                        HeightRequest="50"
                        Grid.Column="2"/>

                <Label Text="{Binding TotalPrice, StringFormat='Итого: {0:C}'}"
                       FontSize="20"
                       TextColor="{StaticResource PrimaryText}"
                       FontAttributes="Bold"
                       HorizontalOptions="End"
                       VerticalOptions="Center"
                       Grid.Column="3"/>
            </Grid>
        </Frame>
    </Grid>
</ContentPage>