<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="TradeCompApp.PaymentPage" 
             xmlns:behavior ="clr-namespace:TradeCompApp.Behaviors"
             xmlns:converter ="clr-namespace:TradeCompApp.Behaviors.Converters"
             Title="Оплата"
             BackgroundColor="{StaticResource PageBackground}">
    <ContentPage.Resources>
        <ResourceDictionary>
            <converter:StringToBoolConverter x:Key="StringToBoolConverter"/>
            <converter:AllTrueConverter x:Key="AllTrueConverter"/>
            <converter:IsNotNullConverter x:Key="IsNotNullConverter"/>
        </ResourceDictionary>
    </ContentPage.Resources>
    <ScrollView>
        <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto,*,Auto" 
              Padding="20"
              RowSpacing="15">

            <!-- Заголовок -->
            <Frame Grid.Row="0"
                   CornerRadius="12"
                   BackgroundColor="White"
                   Padding="15"
                   HasShadow="True">
                <VerticalStackLayout Spacing="5">
                    <Label Text="Сумма к оплате:" 
                           FontSize="16"
                           TextColor="{StaticResource SecondaryText}"/>
                    <Label Text="{Binding TotalPrice, StringFormat='{0:C}'}" 
                           FontSize="28"
                           TextColor="{StaticResource PrimaryButton}"
                           FontAttributes="Bold"/>
                </VerticalStackLayout>
            </Frame>

            <!-- Способ оплаты -->
            <Frame Grid.Row="1"
                   CornerRadius="12"
                   BackgroundColor="White"
                   Padding="15"
                   HasShadow="True">
                <VerticalStackLayout Spacing="10">
                    <Label Text="Способ оплаты" 
                           FontSize="18"
                           TextColor="{StaticResource PrimaryText}"
                           FontAttributes="Bold"/>

                    <Picker Title="Выберите способ..."
                            SelectedItem="{Binding SelectedPayment, Mode=TwoWay}"
                            TextColor="{StaticResource PrimaryText}"
                            TitleColor="{StaticResource SecondaryText}">
                        <Picker.Items>
                            <x:String>Карта</x:String>
                            <x:String>СБП</x:String>
                        
                        </Picker.Items>
                    </Picker>

                    <!-- Поле для карты -->
                    <Entry Placeholder="Номер карты"  Keyboard="Numeric" Text="{Binding CardData}"
                         IsVisible="{Binding SelectedPayment, Converter={StaticResource StringToBoolConverter}, ConverterParameter='Карта'}" >
                          
                        <Entry.Behaviors>
                        <behavior:CardNumberMaskBehavior /> 
                        </Entry.Behaviors>
                    </Entry>
                </VerticalStackLayout>
            </Frame>

            <!-- Способ получения -->
            <Frame Grid.Row="2"
                   CornerRadius="12"
                   BackgroundColor="White"
                   Padding="15"
                   HasShadow="True">
                <VerticalStackLayout Spacing="10">
                    <Label Text="Способ получения" 
                           FontSize="18"
                           TextColor="{StaticResource PrimaryText}"
                           FontAttributes="Bold"/>

                    <Picker Title="Выберите способ..."
                            SelectedItem="{Binding SelectedDelivery, Mode=TwoWay}">
                        <Picker.Items>
                            <x:String>Самовывоз</x:String>
                            <x:String>Курьером</x:String>
                        </Picker.Items>
                    </Picker>
                </VerticalStackLayout>
            </Frame>

            <!-- Дополнительная информация -->
            <Frame Grid.Row="3"
                   CornerRadius="12"
                   BackgroundColor="White"
                   Padding="15"
                   HasShadow="True"
               IsVisible="{Binding SelectedDelivery, Converter={StaticResource StringToBoolConverter}, ConverterParameter='Курьером'}">
                <VerticalStackLayout Spacing="10">
                    <Label Text="Адрес доставки" 
                           FontSize="18"
                           TextColor="{StaticResource PrimaryText}"
                           FontAttributes="Bold"/>

                    <Entry Placeholder="Улица, дом, квартира"
                           Text="{Binding DeliveryAddress}"/>
                </VerticalStackLayout>
            </Frame>

            <!-- Контактные данные -->
            <Frame Grid.Row="4"
                   CornerRadius="12"
                   BackgroundColor="White"
                   Padding="15"
                   HasShadow="True">
                <VerticalStackLayout Spacing="10">
                    <Label Text="Контактные данные" 
                           FontSize="18"
                           TextColor="{StaticResource PrimaryText}"
                           FontAttributes="Bold"/>

                    <Entry Placeholder="Ваше имя"
                           Text="{Binding CustomerName}"/>

                    <Entry Placeholder="Телефон"
                           Text="{Binding CustomerPhone}"
                           Keyboard="Telephone"/>
                </VerticalStackLayout>
            </Frame>

            <!-- Кнопки -->
            <Grid Grid.Row="6"
                  ColumnDefinitions="*,*"
                  ColumnSpacing="15">
                <Button Text="Отмена"
                        Clicked="OnCancelClicked"
                        BackgroundColor="{StaticResource SecondaryButton}"
                        TextColor="White"
                        CornerRadius="10"
                        HeightRequest="50"/>

                <Button Text="Оплатить"
                        Clicked="OnPayClicked"
                        BackgroundColor="{StaticResource PrimaryButton}"
                        TextColor="White"
                        FontAttributes="Bold"
                        CornerRadius="10"
                        HeightRequest="50"
                        Grid.Column="1">
                  
                    <Button.IsEnabled>
                      
                        <MultiBinding Converter="{StaticResource AllTrueConverter}">
                            <Binding Path="SelectedPayment" Converter="{StaticResource IsNotNullConverter}"/>
                            <Binding Path="SelectedDelivery" Converter="{StaticResource IsNotNullConverter}"/>
                           
                            
                        </MultiBinding>
                       
                    </Button.IsEnabled>
                
                </Button>
            </Grid>
        </Grid>
    </ScrollView>
</ContentPage>